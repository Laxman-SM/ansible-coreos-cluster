---
- hosts: localhost
  connection: local
  gather_facts: False
  vars_files:
  - keys/credentials.yaml
  - group_vars/vpc.yaml
  - group_vars/etcd_cluster.yaml
  - group_vars/coreos_cluster.yaml
  - group_vars/rds.yaml

  roles:
    # generate etcd key pair
    - role: keygen
      keypair_region: "{{ ec2_region }}"
      keypair_name: "{{ etcd_keypair_name }}"
      keypair_file: "{{ etcd_keypair_file }}"
    # generate coreos key pair
    - role: keygen
      keypair_region: "{{ ec2_region }}"
      keypair_name: "{{ coreos_keypair_name }}"
      keypair_file: "{{ coreos_keypair_file }}"

    # generate CA https certificate for skydns.local, it must be included in CoreOS
    - role: https_certs

    # generate GPG keyrings for data encryption
    - role: gpg_keyrings

    # create a new VPC
    - role: vpc

    # create RDS
    - role: rds_config

    # create etcd cluster (with autoscaling group)
    - role: etcd_cluster

    # create volumes for coreos cluster
    - role: create_volume
      volume: "{{ es_volume }}"
    - role: create_volume
      volume: "{{ rabbitmq_volume_1 }}"
    - role: create_volume
      volume: "{{ rabbitmq_volume_2 }}"
    - role: create_volume
      volume: "{{ result_upload_volume }}"

    # create coreos cluster (with autoscaling group): must run after etcd_cluster role
    - role: coreos_cluster

    # setup network: VPC peering, NAT, route tables
    - role: network

- hosts: terminate-group
  connection: local
  gather_facts: False
  roles:
    - terminate
